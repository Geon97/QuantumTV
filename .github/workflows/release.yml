name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

# =====================================================
# JOB 1: Create Release (ONLY ONCE)
# =====================================================
jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: QuantumTV ${{ github.ref_name }}
          body: |
            ## QuantumTV ${{ github.ref_name }}

            Desktop (Windows / macOS / Linux) and Android builds are provided below.

            macOS builds are unsigned.  
            If Gatekeeper blocks the app, right-click â†’ Open.
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # =====================================================
  # JOB 2: Desktop Builds
  # =====================================================
  build-desktop:
    needs: create-release
    strategy:
      fail-fast: false
      matrix:
        include:
          # ---------------- macOS ----------------
          - os: macos-latest
            target: aarch64-apple-darwin
          - os: macos-latest
            target: x86_64-apple-darwin

          # ---------------- Linux ----------------
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu

          # ---------------- Windows ----------------
          - os: windows-latest
            target: x86_64-pc-windows-msvc

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      # ---------------- Clean ----------------
      - name: Clean build artifacts (Unix)
        if: runner.os != 'Windows'
        run: |
          rm -rf out src-tauri/target .next

      - name: Clean build artifacts (Windows)
        if: runner.os == 'Windows'
        run: |
          if (Test-Path out) { Remove-Item -Recurse -Force out }
          if (Test-Path src-tauri/target) { Remove-Item -Recurse -Force src-tauri/target }
          if (Test-Path .next) { Remove-Item -Recurse -Force .next }

      # ---------------- Linux deps ----------------
      - name: Install Linux dependencies
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libsoup-3.0-dev \
            libjavascriptcoregtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libssl-dev \
            libnm-dev \
            pkg-config \
            patchelf \
            xdg-utils
          sudo apt-get install -y libfuse2 || sudo apt-get install -y libfuse2t64

      - name: Install WiX Toolset
        if: runner.os == 'Windows'
        run: |
          $wixDir = Get-ChildItem 'C:\Program Files (x86)' -Directory |
            Where-Object { $_.Name -like 'WiX Toolset*' } |
            Sort-Object Name -Descending |
            Select-Object -First 1

          if (-not $wixDir) {
            choco install wixtoolset --version 3.14.1 -y --allow-downgrade
            $wixDir = Get-ChildItem 'C:\Program Files (x86)' -Directory |
              Where-Object { $_.Name -like 'WiX Toolset*' } |
              Sort-Object Name -Descending |
              Select-Object -First 1
          }

          if ($wixDir) {
            $wixBin = Join-Path $wixDir.FullName 'bin'
            if (Test-Path $wixBin) {
              $wixBin | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            } else {
              throw "WiX bin not found at $wixBin"
            }
          } else {
            throw "WiX Toolset not found"
          }

      # ---------------- Toolchains ----------------
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # ---------------- Build ----------------
      - name: Install frontend deps
        run: npm ci

      - name: Build frontend
        run: npm run build
        env:
          NEXT_PUBLIC_STATIC_EXPORT: '1'

      - name: Build Tauri App
        run: |
          npm run tauri build -- --target ${{ matrix.target }}
        env:
          APPIMAGE_EXTRACT_AND_RUN: '1'

      # ---------------- Upload ----------------
      - name: Upload Desktop Artifacts (macOS)
        if: runner.os == 'macOS'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg
            src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Desktop Artifacts (Linux)
        if: runner.os == 'Linux'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            src-tauri/target/${{ matrix.target }}/release/bundle/deb/*.deb
            src-tauri/target/${{ matrix.target }}/release/bundle/rpm/*.rpm
            src-tauri/target/${{ matrix.target }}/release/bundle/appimage/*.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Desktop Artifacts (Windows)
        if: runner.os == 'Windows'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            src-tauri/target/${{ matrix.target }}/release/bundle/msi/*.msi
            src-tauri/target/${{ matrix.target }}/release/bundle/nsis/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # =====================================================
  # JOB 3: Android Build
  # =====================================================
  build-android:
    needs: create-release
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ninja-build \
            libclang-dev \
            pkg-config \
            build-essential \
            curl wget clang llvm

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Android NDK
        run: |
          sdkmanager "ndk;26.1.10909125"
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/26.1.10909125" >> $GITHUB_ENV

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android

      - uses: Swatinem/rust-cache@v2

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2.0.0" --locked

      # ---------------- Android signing ----------------
      - name: Decode keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          ANDROID_STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > src-tauri/gen/android/release.jks
          cat <<EOF > src-tauri/gen/android/key.properties
          keyAlias=$ANDROID_KEY_ALIAS
          keyPassword=$ANDROID_KEY_PASSWORD
          storeFile=release.jks
          storePassword=$ANDROID_STORE_PASSWORD
          EOF

      # ---------------- Build ----------------
      - name: Install frontend deps
        run: npm ci

      - name: Build frontend
        run: npm run build
        env:
          NEXT_PUBLIC_STATIC_EXPORT: '1'

      - name: Build Android APK
        run: |
          chmod +x src-tauri/gen/android/gradlew
          cargo tauri android build --target aarch64

      - name: Rename APK
        run: |
          mv src-tauri/gen/android/app/build/outputs/apk/universal/release/app-universal-release.apk \
             QuantumTV-${{ github.ref_name }}-android-universal.apk

      - name: Upload Android APK
        uses: softprops/action-gh-release@v2
        with:
          files: QuantumTV-${{ github.ref_name }}-android-universal.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
